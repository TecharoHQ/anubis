---
title: Integration with HAProxy via SPOP
---

To avoid proxying of already validated requests through Anubis, HAProxy can be connected using the SPOP protocol.

Example setup:

Client --> HAProxy frontend :443 --> backend Anubis :8923 --> backend App :3923
Client --> HAProxy frontend :443 --> backend App :3923

On any incoming request to the frontend, HAProxy will query Anubis with the cookie contained in the request, asking whether it is valid.

If Anubis returns yes, the client has a valid Anubis cookie, its request will be routed directly to the App backend.
If Anubis returns no, the client does NOT have a valid Anubis cookie, its request will be routed to the Anubis backend, which in return enables the challenge process.
Furthermore, adding health checks it is possible to build a fail-open scenario, meaning that the website continues to work, even if anubis goes down

Example HAProxy configuration:

```
frontend http
  mode http
  bind :::443 v4v6 tfo alpn h2,http/1.1 ssl crt /etc/ssl/crtkey

  filter spoe engine anubis config /etc/haproxy/anubis.cfg
  # The following two ACLs in combination with them being mentioned in the `use_backend` line allow bypass of anubis
  # if it is not working properly (ie. the metrics page is not reachable)
  acl anubis_spoe_healthy nbsrv(anubis-spoe) gt 0
  acl anubis_http_healthy nbsrv(anubis-http) gt 0
  use_backend anubis-http if !{ var(req.anubis.valid) -m bool } anubis_http_healthy anubis_spoe_healthy

  # Optionally: More HAProxy request routing logic

  default_backend web

backend anubis-http
  mode http

  option forwardfor header "X-Real-IP"
  # The next two lines, as well as the `check port 9090` can be removed if no health check is desired
  option httpchk
  http-check send meth GET uri /metrics hdr "X-Real-Ip" "::1"

  server anubis1 2001:db8::42:8923 check port 9090

backend anubis-spoe
  mode tcp

  option httpchk
  http-check send meth GET uri /metrics hdr "X-Real-Ip" "::1"

  server anubis1 2001:db8::42:8923 check port 9090

backend web
  mode http
  server web1 2a02:1748:f7df:9c80::b:3923
```


Example HAProxy SPOE configuration:

```
[anubis]
spoe-agent anubis
  messages check-client-cookie
  option var-prefix anubis
  timeout hello 2s
  timeout idle 5s
  timeout processing 1s
  use-backend anubis-spoe
  log global

spoe-message check-client-cookie
  args cookie=req.cook(within.website-x-cmd-anubis-auth)
  event on-frontend-http-request
```

If HAProxy and Anubis are hosted on the same machine, it is recommended to use a UNIX domain instead of a TCP/IP socket for SPOP communication.
