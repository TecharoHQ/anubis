(()=>{function f(r,n=5,t=navigator.hardwareConcurrency||1){return console.debug("fast algo"),new Promise((e,o)=>{let a=URL.createObjectURL(new Blob(["(",w(),")()"],{type:"application/javascript"})),s=[];for(let i=0;i<t;i++){let c=new Worker(a);c.onmessage=l=>{s.forEach(d=>d.terminate()),c.terminate(),e(l.data)},c.onerror=l=>{c.terminate(),o()},c.postMessage({data:r,difficulty:n,nonce:i,threads:t}),s.push(c)}URL.revokeObjectURL(a)})}function w(){return function(){let r=t=>{let e=new TextEncoder().encode(t);return crypto.subtle.digest("SHA-256",e.buffer)};function n(t){return Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")}addEventListener("message",async t=>{let e=t.data.data,o=t.data.difficulty,a,s=t.data.nonce,i=t.data.threads;for(;;){let c=await r(e+s),l=new Uint8Array(c),d=!0;for(let m=0;m<o;m++){let u=Math.floor(m/2),g=m%2;if((l[u]>>(g===0?4:0)&15)!==0){d=!1;break}}if(d){a=n(l),console.log(a);break}s+=i}postMessage({hash:a,data:e,difficulty:o,nonce:s})})}.toString()}function p(r,n=5,t=1){return console.debug("slow algo"),new Promise((e,o)=>{let a=URL.createObjectURL(new Blob(["(",y(),")()"],{type:"application/javascript"})),s=new Worker(a);s.onmessage=i=>{s.terminate(),e(i.data)},s.onerror=i=>{s.terminate(),o()},s.postMessage({data:r,difficulty:n}),URL.revokeObjectURL(a)})}function y(){return function(){let r=n=>{let t=new TextEncoder().encode(n);return crypto.subtle.digest("SHA-256",t.buffer).then(e=>Array.from(new Uint8Array(e)).map(o=>o.toString(16).padStart(2,"0")).join(""))};addEventListener("message",async n=>{let t=n.data.data,e=n.data.difficulty,o,a=0;do o=await r(t+a++);while(o.substring(0,e)!==Array(e+1).join("0"));a-=1,postMessage({hash:o,data:t,difficulty:e,nonce:a})})}.toString()}var b={fast:f,slow:p},L=(r="",n={})=>{let t=new URL(r,window.location.href);return Object.entries(n).forEach(e=>{let[o,a]=e;t.searchParams.set(o,a)}),t.toString()},h=(r,n)=>L(`/.within.website/x/cmd/anubis/static/img/${r}.webp`,{cacheBuster:n});(async()=>{let r=document.getElementById("status"),n=document.getElementById("image"),t=document.getElementById("title"),e=document.getElementById("spinner"),o=JSON.parse(document.getElementById("anubis_version").textContent);r.innerHTML="Calculating...";let{challenge:a,rules:s}=await fetch("/.within.website/x/cmd/anubis/api/make-challenge",{method:"POST"}).then(u=>{if(!u.ok)throw new Error("Failed to fetch config");return u.json()}).catch(u=>{throw t.innerHTML="Oh no!",r.innerHTML=`Failed to fetch config: ${u.message}`,n.src=h("sad",o),e.innerHTML="",e.style.display="none",u}),i=b[s.algorithm];i||(t.innerHTML="Oh no!",r.innerHTML="Failed to resolve check algorithm. You may want to reload the page.",n.src=h("sad",o),e.innerHTML="",e.style.display="none"),r.innerHTML=`Calculating...<br/>Difficulty: ${s.report_as}`;let c=Date.now(),{hash:l,nonce:d}=await i(a,s.difficulty),m=Date.now();console.log({hash:l,nonce:d}),t.innerHTML="Success!",r.innerHTML=`Done! Took ${m-c}ms, ${d} iterations`,n.src=h("happy",o),e.innerHTML="",e.style.display="none"})();})();
//# sourceMappingURL=main.mjs.map
